<script>
const firebaseConfig = {
  apiKey: "AIzaSyDVcsRaPihq3hoNiEjnIyUgncIL98nJh04",
  authDomain: "gvh30-40e07.firebaseapp.com",
  databaseURL: "https://gvh30-40e07-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "gvh30-40e07"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Unique guest ID
let guestId = localStorage.getItem("gvh_guestId");
if (!guestId) {
  guestId = "g_" + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("gvh_guestId", guestId);
}

const messagesDiv = document.getElementById("messages");

function addBubble(text, sender, time) {
  const row = document.createElement("div");
  row.className = "msg " + sender;
  row.innerHTML = `
    <div class="bubble">
      ${text}
      <div class="time">${time}</div>
    </div>
  `;
  messagesDiv.appendChild(row);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// SEND MESSAGE
document.getElementById("sendBtn").onclick = () => {
  const msg = document.getElementById("message").value.trim();
  if (!msg) return alert("Enter a message");

  const payload = {
    text: msg,
    sender: "guest",
    timestamp: Date.now()
  };

  // Save basic user details if not saved before
  db.ref("chats/" + guestId).update({
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    pickup: document.getElementById("pickup").value.trim(),
    dest: document.getElementById("dest").value.trim(),
    createdAt: Date.now()
  });

  // Push message
  db.ref("chats/" + guestId + "/messages").push(payload);

  document.getElementById("message").value = "";
};

// LOAD MESSAGES LIVE
db.ref("chats/" + guestId + "/messages").on("value", snap => {
  messagesDiv.innerHTML = "";

  snap.forEach(child => {
    const m = child.val();
    addBubble(
      (m.sender === "admin" ? "GVH: " : "") + m.text,
      m.sender === "admin" ? "admin" : "guest",
      new Date(m.timestamp).toLocaleString()
    );
  });
});
</script>
