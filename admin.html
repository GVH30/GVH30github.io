<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GVH Admin — Chat Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0a;
  --primary:#d4af37;
  --muted:#cfcfcf;
  --input-bg:#121212;
  --input-border:#333;
  --shadow: rgba(0,0,0,0.5);
}

body {
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:#eee;
  padding:16px;
}

.wrap {
  max-width:1200px;
  margin:auto;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

h1 { margin:0; color:var(--primary); }
.small { font-size:13px; color:var(--muted); }

.box {
  background:#111;
  border-radius:12px;
  padding:16px;
  border:1px solid rgba(212,175,55,0.06);
  box-shadow:0 4px 16px var(--shadow);
}

input, textarea, button {
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:#fff;
  margin-top:8px;
  font-family:'Inter',sans-serif;
}
input:focus, textarea:focus { border-color:var(--primary); outline:none; }

button {
  background: var(--primary);
  border:none;
  font-weight:700;
  color:#051018;
  cursor:pointer;
  transition: background 0.3s;
}
button:hover { background:#c49f2f; }

.panel { display:grid; grid-template-columns:1fr 2fr; gap:16px; margin-top:16px; }
.list { max-height:75vh; overflow-y:auto; }
.item {
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  cursor:pointer;
  border-left:4px solid transparent;
  transition: background 0.2s, border-left 0.2s;
}
.item.new { border-left-color: var(--primary); }
.item:hover { background:#1a1a1a; }

.chat {
  max-height:75vh;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
  padding-bottom:8px;
}
.msg {
  display:flex;
  align-items:flex-start;
  gap:10px;
  opacity:0;
  transform:translateY(10px);
  animation: fadeInUp 0.3s forwards;
}
.msg img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
.msg .bubble {
  max-width:70%;
  padding:10px 14px;
  border-radius:16px;
  word-wrap: break-word;
  font-size:14px;
}

.msg.guest { flex-direction: row; }
.msg.guest .bubble { background:#1c2b35; color:#fff; border-top-left-radius:0; }

.msg.admin { flex-direction: row-reverse; }
.msg.admin .bubble { background: var(--primary); color:#051018; border-top-right-radius:0; }

textarea { height:90px; resize:none; }

@keyframes fadeInUp { to { opacity:1; transform:translateY(0); } }

</style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>GVH Admin Panel</h1>
    <div>
      <div class="small">Signed in as: <span id="who">-</span></div>
      <button id="logoutBtn" style="display:none;margin-top:4px;">Logout</button>
    </div>
  </header>

  <div id="loginBox" class="box" style="max-width:400px;">
    <div style="font-weight:700; margin-bottom:8px;">Admin Login</div>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn" style="margin-top:12px;">Login</button>
    <div id="loginMsg" class="small" style="margin-top:8px;"></div>
  </div>

  <div id="app" style="display:none;">
    <div class="panel">
      <div class="box list">
        <div style="font-weight:700; margin-bottom:8px;">Incoming Chats</div>
        <div id="chatsList"></div>
      </div>

      <div class="box">
        <div id="chatArea">
          <div id="chatHeader" style="font-weight:700;">Select a chat</div>
          <div id="chatMessages" class="chat" style="margin-top:12px;"></div>
          <textarea id="replyText" placeholder="Type your reply..."></textarea>
          <button id="sendReply" style="margin-top:8px;">Send Reply</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = FIREBASE_CONFIG_HERE;
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const loginBox=document.getElementById('loginBox');
const loginMsg=document.getElementById('loginMsg');
const emailIn=document.getElementById('email');
const passIn=document.getElementById('password');
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const appDiv=document.getElementById('app');
const whoSpan=document.getElementById('who');
const chatsList=document.getElementById('chatsList');
const chatMessages=document.getElementById('chatMessages');
const chatHeader=document.getElementById('chatHeader');
const replyText=document.getElementById('replyText');
const sendReply=document.getElementById('sendReply');

let selectedKey = null;

loginBtn.onclick = ()=>{
  const e=emailIn.value.trim(), p=passIn.value.trim();
  if(!e||!p){ loginMsg.innerText='Enter email and password'; return; }
  loginMsg.innerText='Signing in...';
  auth.signInWithEmailAndPassword(e,p).then(()=>loginMsg.innerText='').catch(err=>loginMsg.innerText=err.message);
};

logoutBtn.onclick = ()=> auth.signOut();

auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.style.display='none';
    appDiv.style.display='block';
    logoutBtn.style.display='inline-block';
    whoSpan.innerText=user.email;
    startListening();
  } else {
    loginBox.style.display='block';
    appDiv.style.display='none';
    logoutBtn.style.display='none';
    whoSpan.innerText='-';
  }
});

function startListening(){
  chatsList.innerHTML='';
  const ref=db.ref('chats').limitToLast(200);
  ref.on('child_added', snap=>addListItem(snap.key,snap.val()));
  ref.on('child_changed', snap=>updateListItem(snap.key,snap.val()));
}

function addListItem(key,val){
  const div=document.createElement('div');
  div.id='item_'+key;
  div.className='item '+(val.status==='new'?'new':'');
  div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>${val.name||'Guest'}</strong><div class="small">${val.phone||''}</div></div>
    <div class="small">${new Date(val.timestamp).toLocaleString()}</div>
  </div>
  <div class="small" style="margin-top:6px;">${val.message.slice(0,120)}</div>`;
  div.onclick=()=>openChat(key,val);
  chatsList.prepend(div);
}

function updateListItem(key,val){
  const el=document.getElementById('item_'+key);
  if(!el) return addListItem(key,val);
  el.className='item '+(val.status==='new'?'new':'');
}

function appendMessage(text, cls, avatar, time){
  const el=document.createElement('div'); el.className='msg '+cls;
  el.innerHTML=`<img src="${avatar}" alt="avatar">
                <div class="bubble">${text}<div class="small">${time||''}</div></div>`;
  chatMessages.appendChild(el);
  chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
}

function openChat(key,val){
  selectedKey=key;
  chatHeader.innerText=`${val.name||'Guest'} — ${val.phone||''}`;
  chatMessages.innerHTML='';
  appendMessage(val.message,'guest','https://i.pravatar.cc/32?u='+key,new Date(val.timestamp).toLocaleString());
  if(val.replies){
    Object.keys(val.replies).forEach(k=>{
      const r=val.replies[k];
      appendMessage(r.message,'admin','logo.png',new Date(r.ts).toLocaleString());
    });
  }
  db.ref('chats/'+key).update({status:'read'});
}

sendReply.onclick = ()=>{
  if(!selectedKey) return alert('Select a chat first');
  const text=replyText.value.trim();
  if(!text) return alert('Type a reply');
  const payload={ message:text, ts:Date.now(), from:'admin' };
  const repliesRef=db.ref('chats/'+selectedKey+'/replies');
  const newKey=repliesRef.push().key;
  const updates={};
  updates['chats/'+selectedKey+'/replies/'+newKey]=payload;
  updates['chats/'+selectedKey+'/status']='replied';
  updates['chats/'+selectedKey+'/lastReplyAt']=Date.now();
  db.ref().update(updates).then(()=>{
    appendMessage(text,'admin','logo.png',new Date().toLocaleString());
    replyText.value='';
  }).catch(err=>alert(err.message));
};
</script>
</body>
</html>
