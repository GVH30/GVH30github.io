<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GVH Admin — Chat Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#05060a;--gold:#d4af37;--muted:#cfcfcf}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#eee;padding:12px}
    .wrap{max-width:1100px;margin:8px auto}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;color:var(--gold)}
    .panel{display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px}
    .box{background:#071017;border-radius:10px;padding:12px;border:1px solid rgba(212,175,55,0.04)}
    input{width:100%;padding:8px;border-radius:6px;border:1px solid #233;background:#061017;color:#fff;margin-top:8px}
    button{background:var(--gold);border:none;padding:8px 12px;border-radius:6px;color:#051018;font-weight:700;cursor:pointer}
    .list{max-height:700px;overflow:auto}
    .item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .item.new{border-left:4px solid var(--gold)}
    .chat{max-height:700px;overflow:auto;padding-bottom:8px}
    .msg{padding:8px;border-radius:8px;margin-bottom:8px;background:#0b1a22}
    .msg.admin{background:var(--gold);color:#051018}
    textarea{width:100%;height:90px;padding:8px;border-radius:6px;border:1px solid #233;background:#061017;color:#fff;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>GVH — Admin Chat Panel</h1>
      <div>
        <div class="small">Signed in as: <span id="who">-</span></div>
        <button id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <div id="loginBox" class="box" style="margin-top:12px;max-width:420px">
      <div style="font-weight:700;margin-bottom:6px">Admin Login</div>
      <input id="email" placeholder="admin email">
      <input id="password" type="password" placeholder="password">
      <div style="margin-top:8px">
        <button id="loginBtn">Login</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>

    <div id="app" style="display:none">
      <div class="panel">
        <div class="box list">
          <div style="font-weight:700;margin-bottom:8px">Incoming Chats</div>
          <div id="chatsList"></div>
        </div>

        <div class="box">
          <div id="chatArea">
            <div id="chatHeader" style="font-weight:700">Select a chat to view</div>
            <div id="chatMessages" class="chat" style="margin-top:8px"></div>

            <div style="margin-top:8px">
              <textarea id="replyText" placeholder="Type your reply..."></textarea>
              <div style="margin-top:8px"><button id="sendReply">Send Reply</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-auth-compat.js"></script>

  <script>
    // ====== PASTE YOUR FIREBASE CONFIG OBJECT BELOW ======
    const firebaseConfig = FIREBASE_CONFIG_HERE;
    // =====================================================
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // UI refs
    const loginBox = document.getElementById('loginBox');
    const loginMsg = document.getElementById('loginMsg');
    const emailIn = document.getElementById('email');
    const passIn = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const appDiv = document.getElementById('app');
    const whoSpan = document.getElementById('who');
    const chatsList = document.getElementById('chatsList');
    const chatMessages = document.getElementById('chatMessages');
    const chatHeader = document.getElementById('chatHeader');
    const replyText = document.getElementById('replyText');
    const sendReply = document.getElementById('sendReply');

    let selectedKey = null;

    loginBtn.onclick = () => {
      const e = emailIn.value.trim();
      const p = passIn.value.trim();
      if(!e||!p){ loginMsg.innerText='Enter email and password'; return; }
      loginMsg.innerText = 'Signing in...';
      auth.signInWithEmailAndPassword(e,p)
        .then(() => loginMsg.innerText = '')
        .catch(err => loginMsg.innerText = err.message);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if(user){
        loginBox.style.display = 'none';
        appDiv.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        whoSpan.innerText = user.email;
        startListening();
      } else {
        loginBox.style.display = 'block';
        appDiv.style.display = 'none';
        logoutBtn.style.display = 'none';
        whoSpan.innerText = '-';
      }
    });

    function startListening(){
      chatsList.innerHTML = '';
      const ref = db.ref('chats').limitToLast(200);
      ref.on('child_added', snap => {
        const key = snap.key;
        const v = snap.val();
        addListItem(key,v);
      });
      ref.on('child_changed', snap => {
        updateListItem(snap.key, snap.val());
      });
    }

    function addListItem(key,val){
      const div = document.createElement('div');
      div.id = 'item_'+key;
      div.className = 'item ' + (val.status==='new'?'new':'');
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${val.name||'Guest'}</strong><div class="small">${val.phone||''}</div></div><div class="small">${new Date(val.timestamp).toLocaleString()}</div></div><div class="small" style="margin-top:6px">${val.message.slice(0,120)}</div>`;
      div.onclick = () => openChat(key,val);
      chatsList.prepend(div);
    }

    function updateListItem(key,val){
      const el = document.getElementById('item_'+key);
      if(!el) return addListItem(key,val);
      el.className = 'item ' + (val.status==='new'?'new':'');
    }

    function openChat(key,val){
      selectedKey = key;
      chatHeader.innerText = `${val.name||'Guest'} — ${val.phone||''}`;
      chatMessages.innerHTML = '';
      // show original message
      const initial = document.createElement('div');
      initial.className = 'msg';
      initial.innerHTML = `<div><strong>Guest:</strong></div><div>${val.message}</div><div class="small">${new Date(val.timestamp).toLocaleString()}</div>`;
      chatMessages.appendChild(initial);

      // show any replies
      if(val.replies){
        Object.keys(val.replies).forEach(k=>{
          const r = val.replies[k];
          const rep = document.createElement('div');
          rep.className = 'msg admin';
          rep.innerHTML = `<div><strong>You:</strong></div><div>${r.message}</div><div class="small">${new Date(r.ts).toLocaleString()}</div>`;
          chatMessages.appendChild(rep);
        });
      }
      // mark as read
      db.ref('chats/'+key).update({status:'read'});
    }

    sendReply.onclick = () => {
      if(!selectedKey) return alert('Select a chat first');
      const text = replyText.value.trim();
      if(!text) return alert('Type a reply');
      const payload = { message:text, ts:Date.now(), from:'admin' };
      const repliesRef = db.ref('chats/'+selectedKey+'/replies');
      const newKey = repliesRef.push().key;
      const updates = {};
      updates['chats/'+selectedKey+'/replies/'+newKey] = payload;
      updates['chats/'+selectedKey+'/status'] = 'replied';
      updates['chats/'+selectedKey+'/lastReplyAt'] = Date.now();
      db.ref().update(updates).then(()=>{
        // append locally
        const rep = document.createElement('div');
        rep.className = 'msg admin';
        rep.innerHTML = `<div><strong>You:</strong></div><div>${text}</div><div class="small">${new Date().toLocaleString()}</div>`;
        chatMessages.appendChild(rep);
        replyText.value = '';
      }).catch(err => alert(err.message));
    };
  </script>
</body>
</html>
